# 1. Get the ID of the taxonomy query input.
# 2. Fetch a list of all species in the taxonomy.
# 3. Create a list of gene identifiers for each species' copy of the given gene.


import sys
import os
import re
import time
import json
import requests
from tqdm import tqdm


ESEARCH = "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi{QUERY}"
EFETCH = "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi{QUERY}"


def taxon_name_to_id(taxon_name: str) -> int:
    """
    Convert a taxon name to a taxon ID using the NCBI Taxonomy Browser API.
    """
    url = ESEARCH.format(QUERY=f"?db=taxonomy&term={taxon_name}")
    r = requests.get(url)
    if r.status_code != 200:
        raise Exception("Error fetching taxon ID from NCBI Taxonomy Browser.")
    return int(re.findall(r"<Id>(\d+)</Id>", r.text)[0])


def fetch_species(taxon_id: int) -> list:
    """
    Fetch all species in the taxonomy using the NCBI Taxonomy Browser API.
    """
    url = ESEARCH.format(QUERY=f"?db=taxonomy&term=txid{taxon_id}[Subtree]&retmax=100000")
    r = requests.get(url)
    if r.status_code != 200:
        raise Exception("Error fetching species from NCBI Taxonomy Browser.")
    
    # The species IDs are under eSearchResult -> IdList -> Id.
    return re.findall(r"<Id>(\d+)</Id>", r.text)


def fetch_gene_id(species_id: int, gene_name: str) -> list:
    """
    Fetch all gene IDs for a given species and gene name using the NCBI Gene API.
    """
    url = ESEARCH.format(QUERY=f"?db=gene&term={gene_name}[Gene Name]+AND+txid{species_id}[Subtree]")
    r = requests.get(url)
    if r.status_code != 200:
        raise Exception("Error fetching gene IDs from NCBI Gene.")
        
    # The gene IDs are under eSearchResult -> IdList -> Id.
    return re.findall(r"<Id>(\d+)</Id>", r.text)


def fetch_gene_ids(species_ids: list, gene_name: str) -> dict:
    """
    Fetch all gene IDs for a given list of species and gene name using the NCBI Gene API.
    """
    gene_ids = {}
    with tqdm(total=len(species_ids), desc="Fetching gene IDs") as pbar:
        for species_id in species_ids:
            gene_ids[species_id] = fetch_gene_id(species_id, gene_name)
            time.sleep(0.5)
            pbar.update(1)
    return gene_ids


if __name__ == '__main__':
    # Get the taxonomy query.
    taxonomy_query = sys.argv[1]

    # Convert the taxonomy query to a taxonomy ID.
    taxonomy_id = taxon_name_to_id(taxonomy_query)

    print(f"Converted '{taxonomy_query}' to taxonomy ID {taxonomy_id}.")

    # Fetch a list of all species in the taxonomy.
    species = fetch_species(taxonomy_id)
    print(f"Found {len(species)} species in the taxonomy.")

    gene_name = sys.argv[2]
    gene_dict = fetch_gene_ids(species, gene_name)
    print(gene_dict)

    d = {'3085341': [], '3085340': [], '3074504': [], '3074503': [], '3074501': [], '3074498': [], '3061928': [], '3043112': [], '3043111': [], '3043110': [], '3043109': [], '3043108': [], '3043107': [], '3043106': [], '3043105': [], '3043104': [], '3043103': [], '3030689': [], '3030688': [], '3030687': [], '3030686': [], '3030685': [], '3016450': [], '2979366': [], '2979365': [], '2979364': [], '2959331': [], '2959330': [], '2959329': [], '2959328': [], '2959327': [], '2959326': [], '2959325': [], '2959324': [], '2959323': [], '2959313': [], '2959312': [], '2959311': [], '2959310': [], '2959309': [], '2959308': [], '2959307': [], '2959306': [], '2959305': [], '2959304': [], '2959303': [], '2959302': [], '2959301': [], '2959300': [], '2952800': [], '2952799': [], '2952798': [], '2952797': [], '2952796': [], '2952771': [], '2952770': [], '2952769': [], '2952768': [], '2952767': [], '2952766': [], '2952765': [], '2952764': [], '2952763': [], '2952762': [], '2952761': [], '2952760': [], '2952759': [], '2946525': [], '2946524': [], '2946523': [], '2946522': [], '2946521': [], '2946520': [], '2946519': [], '2946518': [], '2946517': [], '2946516': [], '2946515': [], '2946514': [], '2946513': [], '2946512': [], '2937889': [], '2933639': [], '2931051': [], '2931050': [], '2931049': [], '2931048': [], '2931047': [], '2931046': [], '2931045': [], '2931044': [], '2931043': [], '2925011': [], '2922388': [], '2922387': [], '2918764': [], '2918763': [], '2918762': [], '2918757': [], '2918756': [], '2905218': [], '2905217': [], '2883641': [], '2883640': [], '2873328': [], '2850016': [], '2850015': [], '2841023': [], '2839868': [], '2839867': [], '2838830': [], '2826950': [], '2822462': [], '2813599': [], '2813598': [], '2805936': [], '2805706': [], '2804203': [], '2768846': [], '2768845': [], '2768844': [], '2767338': [], '2765903': [], '2765902': [], '2765901': [], '2765900': [], '2765899': [], '2765898': [], '2765897': [], '2765896': [], '2765895': [], '2765894': [], '2765893': [], '2765892': [], '2765891': [], '2765890': [], '2765889': [], '2765888': [], '2765887': [], '2765886': [], '2765885': [], '2753606': [], '2753605': [], '2736752': [], '2735722': [], '2715852': ['108286935'], '2704458': [], '2704457': [], '2704456': [], '2704455': [], '2688256': [], '2685534': [], '2683930': [], '2681187': [], '2677806': [], '2665953': [], '2665952': [], '2651172': [], '2650809': [], '2649368': [], '2647113': [], '2646861': [], '2646430': [], '2645779': [], '2645584': [], '2644350': [], '2642123': [], '2641939': [], '2635411': [], '2634122': [], '2632571': [], '2632072': [], '2630091': [], '2628747': [], '2628182': [], '2627897': [], '2624844': [], '2624233': [], '2623509': [], '2623225': [], '2620125': [], '2619504': [], '2619300': [], '2618863': [], '2618788': [], '2618071': [], '2604443': [], '2604442': [], '2604441': [], '2592808': [], '2592807': [], '2592806': [], '2592805': [], '2586294': [], '2586293': [], '2567999': [], '2565306': [], '2565305': [], '2563322': [], '2508170': [], '2490931': [], '2490930': [], '2490929': [], '2488670': [], '2487933': [], '2487713': [], '2487712': [], '2483760': [], '2282232': [], '2269071': [], '2170374': [], '2170373': [], '2170372': [], '2093840': [], '2093839': [], '2093838': [], '2093837': [], '2093836': [], '2093835': [], '2059839': [], '2051901': [], '2023128': [], '2020906': [], '2008792': [], '1985289': [], '1985288': [], '1985287': [], '1971490': [], '1971489': [], '1967466': [], '1967465': [], '1967464': [], '1967463': [], '1967456': [], '1967452': [], '1967451': [], '1967450': [], '1966384': [], '1965113': [], '1965109': [], '1965102': [], '1965096': [], '1945559': [], '1945558': [], '1945557': [], '1945556': [], '1934191': [], '1934190': [], '1903316': [], '1885588': [], '1874197': [], '1868482': ['103277479'], '1868481': [], '1861705': [], '1861704': [], '1861702': [], '1861701': [], '1859147': [], '1840580': [], '1840579': [], '1812110': [], '1812106': [], '1812102': [], '1812042': [], '1812038': [], '1812037': [], '1812036': [], '1812035': [], '1778600': [], '1758239': [], '1758238': [], '1758237': [], '1758231': [], '1748402': [], '1748400': [], '1747270': [], '1738053': [], '1738052': [], '1738051': [], '1738050': [], '1738049': [], '1738048': [], '1738047': [], '1738046': [], '1654737': [], '1618156': [], '1616038': [], '1597978': [], '1592215': [], '1579530': [], '1569974': [], '1561164': [], '1561161': [], '1560631': [], '1560619': [], '1560552': [], '1547595': [], '1532888': [], '1532884': [], '1529884': [], '1513477': [], '1513476': [], '1513475': [], '1513474': [], '1497547': [], '1497546': [], '1487601': [], '1476500': [], '1476079': [], '1472258': [], '1449913': [], '1425170': [], '1417237': [], '1417236': [], '1417231': [], '1411634': [], '1347729': [], '1346251': [], '1328070': [], '1328069': [], '1313325': [], '1313324': [], '1313323': [], '1310125': [], '1310124': [], '1310123': [], '1294088': [], '1290433': [], '1284216': [], '1284215': [], '1276855': [], '1268362': [], '1263727': [], '1230482': [], '1230481': [], '1215604': [], '1215360': [], '1214775': [], '1208734': [], '1208733': [], '1203020': [], '1194336': [], '1194335': [], '1194334': [], '1194333': [], '1194332': [], '1191211': [], '1159185': [], '1144881': [], '1137513': [], '1137512': [], '1137511': [], '1137509': [], '1137508': [], '1137507': [], '1137506': [], '1137505': [], '1137495': [], '1137494': [], '1137491': [], '1137490': [], '1137489': [], '1137488': [], '1137484': [], '1137483': [], '1137482': [], '1137481': [], '1137480': [], '1137476': [], '1137474': [], '1137473': [], '1137444': [], '1137435': [], '1137434': [], '1137433': [], '1137049': [], '1137048': [], '1131379': [], '1127763': [], '1126382': [], '1118394': [], '1118393': [], '1112861': [], '1090919': [], '1090918': [], '1090917': [], '1090916': [], '1090915': [], '1090914': [], '1090913': [], '1090896': [], '1090893': [], '1079039': [], '1068294': [], '1068293': [], '1068292': [], '1046103': [], '1046102': [], '1046101': [], '1046100': [], '1046099': [], '1046098': [], '1046097': [], '1046096': [], '1046095': [], '1046094': [], '1046093': [], '1046092': [], '1046091': [], '1046090': [], '1042121': [], '1002694': [], '989338': [], '981131': [], '976302': [], '976301': [], '976300': [], '976299': [], '976298': [], '942008': [], '940829': [], '905053': [], '886968': [], '886967': [], '886966': [], '886965': [], '886964': [], '886963': [], '886961': [], '886960': [], '886959': [], '886958': [], '886957': [], '881951': [], '881950': [], '881949': [], '881947': [], '881946': [], '873073': [], '873070': [], '873069': [], '873068': [], '873067': [], '873066': [], '867383': [], '867382': [], '867381': [], '867380': [], '867377': [], '867376': [], '867375': [], '867374': [], '867373': [], '867372': [], '867370': [], '867367': [], '867366': [], '867363': [], '867362': [], '867334': [], '867333': [], '867332': [], '867331': [], '864581': [], '864580': [], '859984': [], '859983': [], '795835': [], '767357': [], '767356': [], '767355': [], '764313': [], '756884': [], '756882': [], '752538': [], '744437': [], '741158': [], '716698': [], '716697': [], '716696': [], '716695': [], '716694': [], '716693': [], '716692': [], '716691': [], '716690': [], '716685': [], '716684': [], '693984': [], '693712': [], '666519': [], '662738': [], '662655': [], '662464': [], '658400': [], '658398': [], '658221': [], '649471': [], '642591': [], '639525': [], '638937': [], '630277': [], '626367': [], '614071': [], '607660': [], '595220': [], '593543': [], '591945': [], '591944': [], '591938': [], '591937': [], '591936': ['111545048'], '591935': [], '591934': [], '591933': [], '591932': [], '580599': [], '568393': [], '560240': [], '554167': [], '548482': [], '548481': [], '543560': [], '543559': [], '542827': [], '535897': [], '535896': [], '523825': [], '523824': [], '523822': [], '523821': [], '523820': [], '517013': [], '517012': [], '508712': [], '508710': [], '502961': [], '501791': [], '499232': [], '495300': [], '495299': [], '495298': [], '495297': [], '491853': [], '491852': [], '486960': [], '481705': [], '477174': [], '475619': [], '475618': [], '469557': [], '469556': [], '469555': [], '465719': [], '465718': [], '465717': [], '460675': [], '460674': [], '458173': [], '458171': [], '449596': [], '449501': [], '439030': [], '425246': [], '425245': [], '423450': [], '423449': [], '419588': [], '418100': [], '415977': [], '415757': [], '413234': [], '412761': [], '412760': [], '412759': [], '412758': [], '412752': [], '412751': [], '412750': [], '406788': [], '405039': [], '402888': [], '402244': [], '402239': [], '400023': [], '392815': [], '388736': [], '379532': ['105819013'], '378855': [], '378850': [], '378517': [], '378196': [], '378195': [], '376919': [], '376918': [], '376917': [], '376916': [], '376915': [], '376913': [], '376912': [], '376911': [], '373033': [], '373032': [], '373031': [], '373030': [], '371039': [], '371038': [], '361674': [], '356666': [], '356665': [], '343908': [], '343424': [], '342807': [], '342401': [], '342399': [], '342398': [], '339999': [], '337214': [], '337213': [], '337212': [], '337210': [], '336983': ['105517927'], '327374': [], '325172': [], '325167': [], '325166': [], '325165': [], '322027': [], '322026': [], '322025': [], '322024': [], '322023': [], '322022': [], '322021': [], '322020': [], '314295': [], '314294': [], '314293': [], '310934': [], '310933': [], '310932': [], '310352': [], '304410': [], '304409': [], '303588': [], '303485': [], '300166': [], '300163': [], '300161': [], '292213': [], '291259': [], '290597': [], '288892': [], '288544': [], '285955': [], '285954': [], '285280': [], '281405': [], '281404': [], '280856': [], '280755': [], '280163': [], '280160': [], '278713': [], '272121': [], '272120': [], '272119': [], '272118': [], '272115': [], '272114': [], '271261': [], '271260': [], '270675': [], '270674': [], '270540': [], '270538': [], '269772': [], '263448': [], '261741': [], '261740': [], '261739': [], '261738': [], '261737': [], '261736': [], '261735': [], '261734': [], '261733': [], '261731': [], '261316': [], '260575': [], '257877': ['126949141'], '255237': [], '244255': [], '236288': [], '236287': [], '236275': [], '236274': [], '236272': [], '231953': [], '230833': [], '230653': [], '224329': [], '222417': [], '222416': [], '217956': [], '211508': [], '210166': [], '208510': [], '208091': [], '208090': [], '208089': [], '207598': [], '202458': [], '202457': [], '198702': [], '198701': [], '198627': [], '198115': [], '198114': [], '192893': [], '192863': [], '192862': [], '192861': [], '192860': [], '192859': [], '192858': [], '192857': [], '192856': [], '192855': [], '190117': [], '185953': [], '185596': [], '185591': [], '185590': [], '185458': [], '185457': [], '183511': [], '183328': [], '183327': [], '182257': [], '182256': [], '182254': [], '182253': [], '182252': [], '182251': [], '182250': [], '182249': [], '182248': [], '179089': [], '174599': [], '174598': [], '171947': [], '171945': [], '171293': [], '170207': [], '168259': [], '168015': [], '167131': [], '167130': [], '164651': [], '164650': [], '164648': [], '164647': [], '163110': [], '161496': [], '150249': [], '147650': [], '147649': [], '143354': [], '143353': [], '143352': [], '143351': [], '143283': [], '135486': [], '132548': [], '132108': [], '129801': [], '126594': [], '126593': [], '122765': [], '122388': [], '122247': [], '122246': [], '122245': [], '122232': [], '122231': [], '122230': [], '122229': [], '122225': [], '122224': [], '122222': [], '122221': [], '122220': [], '122219': [], '121123': [], '120432': [], '120088': [], '119640': [], '119639': [], '119638': [], '119634': [], '119633': [], '119632': [], '119631': [], '119630': [], '119629': [], '119628': [], '118649': [], '118648': [], '118647': [], '118644': [], '118643': [], '116962': [], '111174': [], '111173': [], '108082': [], '106398': [], '102108': [], '101841': [], '101278': [], '100937': [], '100936': [], '100754': [], '100489': [], '100488': [], '100487': [], '100475': [], '100224': [], '90388': [], '90387': [], '90386': [], '90385': [], '90384': [], '90383': [], '90382': [], '90381': [], '89672': [], '89671': [], '88029': [], '88028': [], '87289': [], '87288': [], '85699': [], '83691': [], '83281': [], '81944': [], '81572': ['116466782'], '78866': [], '78584': [], '78583': [], '78454': [], '78453': [], '78452': [], '78451': [], '78449': [], '78354': [], '78275': [], '78274': [], '78255': [], '75570': [], '75569': [], '75568': [], '75567': [], '75566': [], '75565': [], '70928': [], '70927': [], '70825': [], '70814': [], '70699': [], '69491': [], '66265': [], '66063': [], '66062': [], '66055': [], '63221': [], '61853': ['100594365'], '61852': [], '61851': [], '61622': ['104676629'], '61621': ['108537557'], '61618': [], '61183': [], '60712': [], '60711': ['103228066'], '60710': [], '58710': [], '57378': [], '57377': [], '57375': [], '57374': [], '57176': [], '57175': [], '57118': [], '54602': [], '54601': [], '54600': [], '54181': [], '54180': ['117083315'], '54137': [], '54136': [], '54135': [], '54134': [], '54133': [], '54132': [], '54131': [], '52232': [], '52231': [], '48842': [], '48018': [], '47180': [], '47178': [], '47177': [], '46359': [], '43780': [], '43779': [], '43778': [], '43777': [], '43147': [], '40843': [], '40322': [], '40297': [], '39582': [], '39432': [], '38071': [], '38070': [], '38069': [], '38068': [], '38066': [], '38039': [], '38020': [], '37589': [], '37588': [], '37295': [], '37294': [], '37293': ['105731221'], '37012': [], '37011': [], '37010': [], '36234': [], '36233': [], '36231': [], '36230': [], '36229': [], '36228': [], '36227': [], '36226': [], '36225': [], '36224': [], '36223': [], '34830': [], '34829': [], '34828': [], '34827': [], '34826': [], '34825': [], '34824': [], '33548': [], '31869': [], '30615': [], '30614': [], '30613': [], '30612': [], '30611': ['100965858'], '30610': [], '30609': [], '30608': ['105882685'], '30603': [], '30602': [], '30601': [], '30600': [], '30599': [], '30598': [], '30597': [], '30596': [], '30595': [], '30594': [], '30593': [], '30592': [], '30591': [], '30590': [], '30589': [], '30588': [], '30587': [], '30586': [], '29089': [], '27680': [], '27679': ['101047659'], '13557': [], '13556': [], '13515': [], '13514': [], '13513': [], '13149': [], '13038': [], '9606': ['6010', '29984'], '9605': [], '9604': [], '9603': [], '9602': [], '9601': ['100450798'], '9600': ['129033521'], '9599': [], '9598': ['460685'], '9597': ['100993085'], '9596': [], '9595': ['101135740'], '9593': [], '9592': [], '9590': ['129471009'], '9589': [], '9588': [], '9587': [], '9586': [], '9583': [], '9581': [], '9580': [], '9579': [], '9578': [], '9577': [], '9576': [], '9573': [], '9572': [], '9570': [], '9569': [], '9568': ['105535198'], '9567': [], '9565': ['112619241'], '9564': [], '9562': [], '9561': [], '9557': [], '9556': [], '9555': ['101018726'], '9554': [], '9553': [], '9552': [], '9551': [], '9549': [], '9548': [], '9546': [], '9545': ['105477769'], '9544': ['702931'], '9543': [], '9542': [], '9541': ['102128424'], '9540': [], '9539': [], '9538': [], '9537': [], '9536': [], '9535': [], '9534': [], '9533': [], '9532': [], '9531': ['105585845'], '9530': [], '9529': [], '9528': [], '9527': [], '9526': [], '9525': [], '9524': [], '9523': [], '9522': [], '9521': [], '9520': [], '9519': [], '9518': [], '9517': [], '9516': [], '9515': ['116539436'], '9514': [], '9513': [], '9511': [], '9510': [], '9509': [], '9508': [], '9507': [], '9506': [], '9505': [], '9504': [], '9503': [], '9502': [], '9499': [], '9498': [], '9495': [], '9494': [], '9493': [], '9491': [], '9490': [], '9489': [], '9488': [], '9487': [], '9486': [], '9485': [], '9483': ['103788338', '100393724'], '9482': [], '9481': [], '9480': [], '9479': [], '9477': [], '9476': [], '9475': [], '9473': [], '9472': [], '9471': [], '9470': ['128591584'], '9469': [], '9468': [], '9467': [], '9465': [], '9464': [], '9463': [], '9462': [], '9461': [], '9460': [], '9459': [], '9455': [], '9454': [], '9453': [], '9452': [], '9447': ['123638131'], '9446': [], '9445': [], '9443': []}

    # count how many species have the gene
    count = 0
    for key in d:
        if d[key]:
            count += 1
    print(count)